<!-- cut length ,delivery fields, rolling/folding -->

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Generate Bill</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- SweetAlert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            background: #f5f1e6;
            font-family: "Times New Roman", serif;
        }

        .bill-card {
            background: #fffdf5;
            border: 2px solid #333;
            padding: 30px;
            max-width: 900px;
            margin: 30px auto;
        }

        .contract-header {
            text-align: center;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        label {
            font-weight: bold;
            font-size: 0.9rem;
        }

        .form-control {
            border: none;
            border-bottom: 1px solid #000;
            border-radius: 0;
            background: transparent;
        }

        .section-box {
            border: 1px solid #000;
            padding: 10px;
            margin-bottom: 15px;
        }

        .btn-submit {
            background: #333;
            color: #fff;
            font-weight: bold;
        }

        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: rgba(255,255,255,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
    </style>
</head>

<body>
<nav class="navbar navbar-dark bg-dark px-3 d-flex justify-content-between">

    <span class="navbar-brand">ShreeGuru Software Solutions welcome</span> <span class = "navbar-brand" th:text="${username}"> user </span>
    
    <div class="d-flex align-items-center">

        <ul class="navbar-nav flex-row">
        <li class="nav-item me-3">
                <a class="nav-link text-white" href="/dashboard">Dashboard</a>
            </li>
            
            <li class="nav-item">
          		<a class="nav-link text-white" href="/weaver-trader">Weaver / Trader Master  </a>
        	</li>
            
            <li class="nav-item me-3">
                <a class="nav-link text-white" href="/report">Reports</a>
            </li>
        </ul>

        <!-- Logout MUST be POST -->
        <form action="/logout" method="post">
    		<button class="btn btn-danger btn-sm">Logout</button>
		</form>


    </div>
</nav>

<!-- Loader -->
<div id="loadingOverlay">
    <div class="text-center">
        <div class="spinner-border text-dark" style="width:4rem;height:4rem"></div>
        <div class="mt-2 fw-bold">Processing...</div>
    </div>
</div>

<div class="bill-card">

    <div class="contract-header">
        <h4>Airjet Loom Owner's Association, Ichalkaranji</h4>
        <small>JOB CONTRACT</small>
    </div>

    <form id="billForm">
        <div class="row section-box">
            <div class="col-md-4">
                <label>Date</label>
                <input type="date" class="form-control" name="contract_date" required>
            </div>
        </div>

        <div class="section-box">
    		<label>Weaver</label>
    		<select class="form-control mb-2" name="weaver_name" required>
        		<option value="">Select Weaver</option>
        		<option th:each="w : ${weavers}"
                	th:value="${w.name}"
                	th:text="${w.name}">
        		</option>
    		</select>

    		<label>Trader</label>
    		<select class="form-control mb-2" name="trader_name" required>
        		<option value="">Select Trader</option>
        		<option th:each="t : ${traders}"
                	th:value="${t.name}"
                	th:text="${t.name}">
        		</option>
    		</select>
    		
    		<label>
        Broker :
        <span th:text="${#authentication.principal.name}"></span>
    </label>
</div>


        <div class="section-box">
            <label>Quality</label>
            <input class="form-control mb-2" name="quality">

            <label>Quantity (Meters)</label>
            <input class="form-control mb-2" name="quantity_meters">
            
            <label>beam</label>
            <input class="form-control mb-2" name="beams">
            
        </div>

        <div class="section-box">
            <label>Job Rate</label>
            <input class="form-control mb-2" name="job_rate">

            <label>Payment Days</label>
            <input class="form-control mb-2" name="payment_days">
        </div>

        <div class="section-box">
            <label>Production Schedule</label>
            <input class="form-control mb-2" name="production_schedule">

            <label>No of Machines</label>
            <input class="form-control mb-2" name="no_of_machines">
        </div>

        <div class="section-box">
            <label>Remark</label>
            <input class="form-control" name="remark">
        </div>
        <div class="section-box">
    <label>Cut Length</label>
    <input class="form-control mb-2" name="cut_length">

    <label>Minimum Delivery</label>
    <input class="form-control mb-2" name="minimum_delivery">

    <label>Rolling / Folding</label>
    <div class="form-check">
        <input class="form-check-input" type="checkbox"
               name="rolling_folding" value="ROLLING" id="rolling">
        <label class="form-check-label" for="rolling">
            Rolling
        </label>
    </div>
    <div class="form-check">
        <input class="form-check-input" type="checkbox"
               name="rolling_folding" value="FOLDING" id="folding">
        <label class="form-check-label" for="folding">
            Folding
        </label>
    </div>
</div>
        

        <button type="submit" id="submitBtn" class="btn btn-submit w-100 mt-3">
            SUBMIT
        </button>

        <button type="button" class="btn btn-outline-dark w-100 mt-2"
                data-bs-toggle="modal" data-bs-target="#previewModal"
                onclick="loadPreview()">
            Generate Bill
        </button>

    </form>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Bill Preview</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="previewContent"></pre>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const form = document.getElementById("billForm");
    const loader = document.getElementById("loadingOverlay");
    const submitBtn = document.getElementById("submitBtn");

    form.addEventListener("submit", function (e) {
        e.preventDefault();

        if (!form.checkValidity()) {
            Swal.fire("Validation Error", "Please fill required fields", "error");
            return;
        }

        submitBtn.disabled = true;
        loader.style.display = "flex";

        const formData = new URLSearchParams(new FormData(form));

        fetch("/gen_bill", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: formData
        })
        .then(res => res.text())
        .then(() => {
            loader.style.display = "none";
            submitBtn.disabled = false;
            Swal.fire("Success", "Job contract created successfully", "success");
            form.reset();
        })
        .catch(() => {
            loader.style.display = "none";
            submitBtn.disabled = false;
            Swal.fire("Error", "Server error occurred", "error");
        });
    });

    function loadPreview() {
        const formData = new FormData(form);
        let preview = "";
        for (let [k, v] of formData.entries()) {
            preview += `${k.replaceAll("_"," ").toUpperCase()} : ${v}\n`;
        }
        document.getElementById("previewContent").innerText = preview;
    }
</script>

</body>
</html>
